<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Atovio Air Purifier</title>
<meta name="theme-color" content="#2563eb" />
<style>
  :root{
    --bg:#ffffff; --fg:#0b1020; --muted:#6b7280; --card:#f8fafc; --line:#e5e7eb; --accent:#2563eb;
    --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
  }
  [data-theme="dark"]{
    --bg:#0b1020; --fg:#e5e7eb; --muted:#9ca3af; --card:#0f172a; --line:#334155; --accent:#60a5fa;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
  .app{max-width:560px; margin:0 auto; padding:16px 16px calc(env(safe-area-inset-bottom,0) + 16px);}
  header{ display:flex; align-items:center; gap:12px; margin-bottom:12px; }
  header img{ width:64px; height:64px; object-fit:cover; border-radius:14px; border:1px solid var(--line); background:#fff; }
  .title{ font-weight:700; font-size:18px; }
  .muted{ color:var(--muted); font-size:12px; }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px; margin-bottom:12px; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .pill{ padding:4px 10px; border-radius:999px; border:1px solid var(--line); font-size:12px; background:var(--bg); }
  #status{ font-weight:600; }
  .btn{ padding:12px 14px; border-radius:12px; border:1px solid var(--line); background:var(--bg); color:var(--fg); font-weight:600; flex:1 1 auto; }
  .btn:active{ transform:translateY(1px) }
  .btn-primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
  .btn:disabled{ opacity:.5 }
  .grid{ display:grid; gap:10px; grid-template-columns:1fr 1fr; }
  .kv{ display:grid; grid-template-columns: 1fr; gap:6px; }
  .label{ font-size:12px; color:var(--muted); }
  .value{ font: 700 24px/1.15 ui-monospace,SFMono-Regular,Menlo,monospace; padding:10px 12px; border:1px solid var(--line); background:var(--bg); border-radius:12px; min-height:44px; display:flex; align-items:center; }
  .toolbar{ display:flex; gap:10px; align-items:center; }
  .grow{ flex:1 1 auto; }
  .toggle{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:var(--bg); }
  .seg{ display:inline-flex; border:1px solid var(--line); border-radius:12px; overflow:hidden; }
  .seg button{ border:0; padding:10px 14px; background:transparent; color:var(--fg); font-weight:700; }
  .seg button.active{ background:var(--accent); color:#fff; }
  details{ border:1px dashed var(--line); border-radius:12px; padding:10px; background:transparent; }
  details summary{ cursor:pointer; font-weight:600; }
  #log{ margin-top:8px; font:12px/1.5 ui-monospace,monospace; white-space:pre-wrap; max-height:160px; overflow:auto; background:#0f172a; color:#e5e7eb; padding:10px; border-radius:10px; }
  @media (max-width:380px){ .grid{ grid-template-columns:1fr; } header img{ width:56px; height:56px; } }
</style>
</head>
<body>
<div class="app">
  <header>
    <img id="productImg" alt="Atovio Air Purifier" />
    <div>
      <div class="title">Atovio Air Purifier</div>
      <div class="muted">Bluetooth Control & Live Stats</div>
    </div>
    <div class="grow"></div>
    <button id="btnTheme" class="toggle">üåô</button>
  </header>

  <div class="card">
    <div class="row" style="margin-bottom:8px;">
      <div id="status">Status: Idle</div>
      <span class="pill" id="devName">Device: ‚Äî</span>
      <span class="pill" id="devId">ID: ‚Äî</span>
    </div>
    <div class="row">
      <button id="btnConnect"   class="btn btn-primary">Connect</button>
      <button id="btnReconnect" class="btn" disabled>Reconnect</button>
      <button id="btnDisconnect"class="btn" disabled>Disconnect</button>
      <button id="btnScan"      class="btn" disabled>Re-scan</button>
      <button id="btnClearLog"  class="btn">Clear Log</button>
    </div>
  </div>

  <!-- Mode control -->
  <div class="card">
    <div class="label" style="margin-bottom:6px;">Mode</div>
    <div class="seg" id="modeSeg">
      <button data-mode="off">Off</button>
      <button data-mode="normal" class="active">Normal</button>
      <button data-mode="turbo">Turbo</button>
    </div>
  </div>

  <!-- Live data -->
  <div class="card">
    <div class="grid">
      <div class="kv"><div class="label">Voltage</div><div class="value" id="valVolt">‚Äî</div></div>
      <div class="kv"><div class="label">Battery %</div><div class="value" id="valPct">‚Äî</div></div>
      <div class="kv"><div class="label">Charging</div><div class="value" id="valCharge">‚Äî</div></div>
      <div class="kv"><div class="label">State</div><div class="value" id="valState">‚Äî</div></div>
    </div>
  </div>

  <!-- Friendly usage view (computed from Speeds counters) -->
  <div class="card">
    <div class="kv" style="grid-column:1 / -1;">
      <div class="label">You used the device today for</div>
      <div class="value" id="valUseToday">‚Äî</div>
    </div>
    <div class="grid" style="margin-top:8px;">
      <div class="kv"><div class="label">Total time at Normal</div><div class="value" id="valUseNormal">‚Äî</div></div>
      <div class="kv"><div class="label">Total time at Turbo</div><div class="value" id="valUseTurbo">‚Äî</div></div>
    </div>
  </div>

  <details>
    <summary>Log</summary>
    <div id="log"></div>
  </details>
</div>

<script>
/* ======== Config ======== */
// Set your real product image URL (HTTPS) or leave blank for the placeholder SVG
const PRODUCT_IMAGE_URL = "";
// Device UUIDs
const PRIMARY_SERVICE = "12345678-1234-5678-1234-56789abcdef0";
const UUIDS = {
  state:  "12345678-1234-5678-1234-56789abcdef0", // Mode/State: text + write
  volt:   "87654321-1234-5678-1234-56789abcdef0",
  pct:    "abcdef01-1234-5678-1234-56789abcdef0",
  charge: "abcdef12-3456-7890-abcd-ef1234567890",
  speeds: "a7654321-4321-6789-4321-abcdef012345"  // "Off: <s>, Slow: <s>, Fast: <s>"
};

/* ======== State ======== */
let device, server, service;
let reconnecting = false, reconnectBackoffMs = 500;
let wakeLock = null;
const charCache  = new Map(); // uuid -> { ch, serviceUUID }
const pollTimers = new Map(); // uuid -> interval id
const valueCache = new Map(); // uuid -> last string (for display)
const td = new TextDecoder();

/* ======== DOM helpers ======== */
const $ = s => document.querySelector(s);
const logEl = $('#log');
function log(msg, level='info'){
  const stamp = new Date().toLocaleTimeString();
  const line = `[${stamp}] ${msg}`;
  logEl.textContent += line + "\n";
  logEl.scrollTop = logEl.scrollHeight;
  console[level === 'error' ? 'error' : (level==='warn' ? 'warn' : 'log')](line);
}
function setStatus(txt, cls=''){ $('#status').textContent = `Status: ${txt}`; $('#status').className = cls; }
function setKv(id, text){ $(id).textContent = text; }
function sanitizeUuid(u){ return (u||'').trim().toLowerCase(); }
function uiEnable(connected){
  $('#btnConnect').disabled    = connected;
  $('#btnDisconnect').disabled = !connected;
  $('#btnReconnect').disabled  = !device;
  $('#btnScan').disabled       = !connected;
}
function rememberValue(uuid, value){ valueCache.set(sanitizeUuid(uuid), value); }

/* ======== Format helpers ======== */
function toHMSFull(t){
  t = Math.max(0, parseInt(t||0,10));
  const h = Math.floor(t/3600), m = Math.floor((t%3600)/60), s = t%60;
  const parts = [];
  if (h) parts.push(`${h}h`);
  if (m || h) parts.push(`${m}m`);
  parts.push(`${s}s`);
  return parts.join(' ');
}
const prettify = {
  voltage: v => { const s=String(v).trim(); const num=parseFloat(s.replace(/[^\d.]/g,'')); return isNaN(num)?(s||'‚Äî'):`${num.toFixed(2)}v`; },
  percent: v => { const s=String(v).trim(); const num=parseFloat(s.replace(/[^\d.]/g,'')); return isNaN(num)?(s||'‚Äî'):`${Math.round(num)}%`; },
  charging: v => { const s=String(v).trim().toLowerCase(); if(!s) return '‚Äî'; if(s.includes('not')) return 'Not Charging'; if(s.includes('charg')) return 'Charging'; return String(v); }
};
function parseValue(dv){
  if (!dv) return '‚Äî';
  const bytes = new Uint8Array(dv.buffer);
  try{ const str = td.decode(bytes); if (/[ -~]/.test(str) && str.trim().length) return str; }catch{}
  return '0x ' + Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join(' ');
}

/* ======== Connect & resilience ======== */
async function ensureConnected(){
  if (!device) throw new Error('No device selected');
  if (device.gatt?.connected) return device.gatt;
  setStatus('Reconnecting‚Ä¶');
  try{
    const g = await device.gatt.connect();
    server = g;
    setStatus('Connected');
    log('Reconnected to GATT');
    return g;
  }catch(e){ handleError('ensureConnected', e); throw e; }
}
async function tryReconnect(){
  if (reconnecting || !device) return;
  reconnecting = true; reconnectBackoffMs = 500;
  while (device && !device.gatt.connected){
    try{
      await device.gatt.connect();
      server = device.gatt;
      log('Auto-reconnect succeeded');
      reconnecting = false;
      charCache.clear();
      for (const [,iid] of pollTimers) clearInterval(iid);
      pollTimers.clear();
      await scanGatt(); await startDataFlows();
      return;
    }catch(e){
      log(`Reconnect failed: ${e.message} ‚Äî retrying in ${reconnectBackoffMs}ms`, 'warn');
      await new Promise(r=>setTimeout(r, reconnectBackoffMs));
      reconnectBackoffMs = Math.min(reconnectBackoffMs*2, 8000);
    }
  }
  reconnecting = false;
}
async function getCharacteristic(uuid){
  const id = sanitizeUuid(uuid);
  if (!id) throw new Error('Empty UUID');
  const cached = charCache.get(id);
  if (cached?.ch) return cached.ch;

  const g = await ensureConnected();
  if (service){
    try{ const ch = await service.getCharacteristic(id); charCache.set(id,{ch,serviceUUID:service.uuid}); return ch; }catch(_){}
  }
  const services = await g.getPrimaryServices();
  for (const s of services){
    try{ const ch = await s.getCharacteristic(id); charCache.set(id,{ch,serviceUUID:s.uuid}); return ch; }catch(_){}
  }
  throw new Error(`Characteristic ${id} not found under allowed services.`);
}
async function scanGatt(){
  try{
    setStatus('Scanning‚Ä¶');
    const g = await ensureConnected();
    service = await g.getPrimaryService(PRIMARY_SERVICE);
    // warm cache for the ones we need
    for (const id of Object.values(UUIDS)){ try{ await getCharacteristic(id); }catch(_){ } }
    setStatus('Connected (ready)');
  }catch(e){ handleError('scanGatt', e); }
}

/* ======== Subscribe / Poll ======== */
async function subscribe(uuid, onValue){
  const id = sanitizeUuid(uuid);
  await ensureConnected();
  const ch = await getCharacteristic(id);
  const props = ch.properties || {};

  try{ const v = await ch.readValue(); const parsed = parseValue(v); rememberValue(id, parsed); onValue(parsed); }
  catch(e){ handleError(`initialRead(${id})`, e, {silent:true}); }

  if (props.notify || props.indicate){
    try{
      ch.addEventListener('characteristicvaluechanged', ev=>{
        try{ const parsed = parseValue(ev.target.value); rememberValue(id, parsed); onValue(parsed); }
        catch(err){ handleError(`onValue(${id})`, err); }
      });
      await ch.startNotifications();
      log(`Notifications started on ${id}`);
      return {subscribed:true};
    }catch(e){ handleError(`startNotifications(${id})`, e, {silent:true}); }
  }
  log(`Falling back to polling on ${id}`, 'warn');
  await poll(id, onValue, 2000);
  return {subscribed:false};
}
async function poll(uuid, onValue, ms=2000){
  const id = sanitizeUuid(uuid);
  const acquire = async () => { await ensureConnected(); return await getCharacteristic(id); };
  let ch = await acquire();
  if (pollTimers.has(id)){ clearInterval(pollTimers.get(id)); pollTimers.delete(id); }
  const tick = async () => {
    try{
      const v = await ch.readValue();
      const parsed = parseValue(v);
      rememberValue(id, parsed);
      onValue(parsed);
    }catch(e){
      log(`poll.read(${id}) failed: ${e.message} ‚Äî reconnecting`, 'warn');
      try{ await ensureConnected(); ch = await acquire(); }catch(e2){ handleError(`poll.reconnect(${id})`, e2); }
    }
  };
  await tick();
  const iid = setInterval(tick, ms);
  pollTimers.set(id, iid);
  log(`Polling ${id} every ${ms}ms`);
}

/* ======== Usage tracking (today) ======== */
// We treat Speeds as cumulative counters since last device reset.
// We keep a per-device, per-day baseline in localStorage to compute "today" deltas.
function todayKeyForDevice(devId){
  const d = new Date(); // local date (customer‚Äôs local time)
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `atovio_usage_baseline_${devId || 'unknown'}_${yyyy}-${mm}-${dd}`;
}
function loadBaseline(devId){
  try{ const s = localStorage.getItem(todayKeyForDevice(devId)); if (s) return JSON.parse(s); }catch(_){}
  return null;
}
function saveBaseline(devId, base){
  try{ localStorage.setItem(todayKeyForDevice(devId), JSON.stringify(base)); }catch(_){}
}
function parseSpeeds(raw){
  const txt = String(raw || '');
  const map = {Off:0, Slow:0, Fast:0};
  txt.split(',').map(x=>x.trim()).forEach(x=>{
    const i = x.indexOf(':'); if (i === -1) return;
    const k = x.slice(0,i).trim();
    const val = x.slice(i+1).trim().replace(/[^\d]/g,'');
    if (k in map) map[k] = parseInt(val||'0',10);
  });
  return map; // seconds
}
function updateUsageUIFromCounts(counts){
  const devId = device?.id || 'unknown';
  let base = loadBaseline(devId);
  // if no baseline yet or counters decreased (device reset), set baseline = current
  if (!base || counts.Slow < base.Slow || counts.Fast < base.Fast || counts.Off < base.Off){
    base = {Off:counts.Off, Slow:counts.Slow, Fast:counts.Fast};
    saveBaseline(devId, base);
  }
  const slowDelta  = Math.max(0, counts.Slow - base.Slow);
  const fastDelta  = Math.max(0, counts.Fast - base.Fast);
  const totalDelta = slowDelta + fastDelta;

  setKv('#valUseToday',  toHMSFull(totalDelta));
  setKv('#valUseNormal', toHMSFull(slowDelta));
  setKv('#valUseTurbo',  toHMSFull(fastDelta));
}

/* ======== App flows ======== */
async function startDataFlows(){
  await subscribe(UUIDS.volt,   v => setKv('#valVolt',  prettify.voltage(v)));
  await subscribe(UUIDS.pct,    v => setKv('#valPct',   prettify.percent(v)));
  await subscribe(UUIDS.charge, v => setKv('#valCharge',prettify.charging(v)));
  await subscribe(UUIDS.state,  v => {
    const s = String(v).trim();
    setKv('#valState', s || '‚Äî');
    // reflect into segmented control
    const lower = s.toLowerCase();
    const mode = lower.includes('turbo') ? 'turbo' : (lower.includes('normal') ? 'normal' : (lower.includes('off') ? 'off' : null));
    if (mode) setActiveMode(mode, false);
  });

  // Poll speeds ‚Üí compute "today" usage
  await poll(UUIDS.speeds, raw => {
    const counts = parseSpeeds(raw);
    updateUsageUIFromCounts(counts);
  }, 2000);
}

/* ======== Mode control (writes 'o'/'n'/'t') ======== */
function setActiveMode(mode, write=true){
  document.querySelectorAll('#modeSeg button').forEach(b=>b.classList.remove('active'));
  const btn = document.querySelector(`#modeSeg button[data-mode="${mode}"]`);
  if (btn) btn.classList.add('active');
  if (write){
    const map = {off:'o', normal:'n', turbo:'t'};
    const payload = map[mode] || 'n';
    writeControlText(payload);
  }
}
async function writeControlText(s){
  const id = sanitizeUuid(UUIDS.state);
  try{
    await ensureConnected();
    const ch = await getCharacteristic(id);
    if (!(ch.properties.write || ch.properties.writeWithoutResponse)){
      log(`Write not supported on ${id}`, 'warn'); return;
    }
    await ch.writeValue(new TextEncoder().encode(s));
    log(`Wrote text "${s}" to ${id}`);
  }catch(e){ handleError(`writeControl(${id})`, e); }
}

/* ======== Lifecycle ======== */
function onDisconnected(){
  uiEnable(false);
  setStatus('Disconnected');
  for (const [,iid] of pollTimers) clearInterval(iid);
  pollTimers.clear();
  log('Device disconnected');
  tryReconnect();
}
async function disconnect(){
  try{ if (device && device.gatt?.connected) device.gatt.disconnect(); }
  catch(e){ handleError('disconnect', e); }
  finally{ onDisconnected(); }
}
function handleError(where, e, opts={}){
  const name = e?.name || 'Error';
  const msg  = e?.message || String(e);
  const hint = hintForError(name, msg);
  if (!opts.silent){
    log(`${where}: ${name}: ${msg}`, 'error');
    if (hint) log(`Hint: ${hint}`, 'warn');
    setStatus(`${name}: ${msg}`, 'err');
  }
}
function hintForError(name, msg){
  const m = (msg||'').toLowerCase();
  if (m.includes('not supported') && m.includes('bluetooth')) return 'This browser/device does not support Web Bluetooth.';
  if (m.includes('not found under allowed services')) return 'Firmware UUID outside allowed service.';
  if (m.includes('no services matching')) return 'Service not found on device.';
  if (m.includes('security') || m.includes('not authorized') || m.includes('insufficient')) return 'Requires pairing; accept the OS prompt.';
  if (m.includes('disconnected')) return 'Move closer / keep screen awake.';
  return '';
}

/* ======== UI events ======== */
$('#btnConnect').onclick = async () => {
  try{
    if (!navigator.bluetooth){ alert('This browser does not support Web Bluetooth. Use Chrome on Android or Desktop.'); return; }
    setStatus('Requesting device‚Ä¶');
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices:true,
      optionalServices:[PRIMARY_SERVICE]
    });
    device.addEventListener('gattserverdisconnected', onDisconnected);
    $('#devName').textContent = 'Device: ' + (device.name || 'Unknown');
    $('#devId').textContent   = 'ID: ' + (device.id || '‚Äî');

    setStatus('Connecting‚Ä¶');
    server = await device.gatt.connect();
    service = await server.getPrimaryService(PRIMARY_SERVICE);

    if ('wakeLock' in navigator && !wakeLock){
      try{ wakeLock = await navigator.wakeLock.request('screen'); wakeLock.addEventListener?.('release', ()=>{ wakeLock=null; }); log('Wake lock acquired'); }
      catch(e){ log('Wake lock failed: ' + e.message, 'warn'); }
    }

    uiEnable(true);
    setStatus('Connected');
    log(`Connected to ${device.name || 'device'} (${device.id || 'no-id'})`);

    // init usage baseline for today (if absent)
    const base = loadBaseline(device.id);
    if (!base) saveBaseline(device.id, {Off:0,Slow:0,Fast:0}); // will be replaced on first speeds read

    await scanGatt();
    await startDataFlows();
  }catch(e){ handleError('connectFlow', e); }
};
$('#btnReconnect').onclick = async () => { try{ await ensureConnected(); await scanGatt(); await startDataFlows(); }catch(e){ handleError('reconnect', e); } };
$('#btnDisconnect').onclick = () => disconnect();
$('#btnScan').onclick       = () => scanGatt();
$('#btnClearLog').onclick   = () => { $('#log').textContent=''; };

document.querySelectorAll('#modeSeg button').forEach(btn=>{
  btn.onclick = () => setActiveMode(btn.dataset.mode, true);
});

const root = document.documentElement;
$('#btnTheme').onclick = () => {
  if (root.getAttribute('data-theme')==='dark'){ root.removeAttribute('data-theme'); $('#btnTheme').textContent='üåô'; }
  else { root.setAttribute('data-theme','dark'); $('#btnTheme').textContent='‚òÄÔ∏è'; }
};

// Product image
(function setProductImg(){
  const el = $('#productImg');
  if (PRODUCT_IMAGE_URL){ el.src = PRODUCT_IMAGE_URL; }
  else{
    const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='128' height='128' viewBox='0 0 128 128'>
      <rect x='16' y='10' width='96' height='108' rx='16' ry='16' fill='%23ffffff' stroke='%232563eb' stroke-width='3'/>
      <rect x='24' y='22' width='80' height='20' rx='6' ry='6' fill='%232563eb' opacity='0.1'/>
      <rect x='24' y='50' width='80' height='8' rx='4' ry='4' fill='%232563eb' opacity='0.15'/>
      <rect x='24' y='64' width='80' height='8' rx='4' ry='4' fill='%232563eb' opacity='0.15'/>
      <rect x='24' y='78' width='80' height='8' rx='4' ry='4' fill='%232563eb' opacity='0.15'/>
      <circle cx='64' cy='102' r='8' fill='%232563eb'/>
    </svg>`);
    el.src = `data:image/svg+xml;utf8,${svg}`;
  }
})();

// Unsupported browser notice
document.addEventListener('DOMContentLoaded', () => {
  if (!('bluetooth' in navigator)){
    setStatus('Web Bluetooth not supported', 'err');
    log('Web Bluetooth unsupported on this device/browser', 'error');
  }
});
</script>
</body>
</html>
