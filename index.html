<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Atovio Air Purifier</title>
<meta name="theme-color" content="#2563eb" />
<style>
  :root{
    --bg:#ffffff; --fg:#0b1020; --muted:#6b7280; --card:#f8fafc; --line:#e5e7eb; --accent:#2563eb;
    --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
  }
  [data-theme="dark"]{
    --bg:#0b1020; --fg:#e5e7eb; --muted:#9ca3af; --card:#0f172a; --line:#334155; --accent:#60a5fa;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  }
  .app{max-width:560px; margin:0 auto; padding:16px 16px calc(env(safe-area-inset-bottom,0) + 16px);}
  header{
    display:flex; align-items:center; gap:12px; margin-bottom:12px;
  }
  header img{ width:64px; height:64px; object-fit:cover; border-radius:14px; border:1px solid var(--line); background:#fff; }
  .title{ font-weight:700; font-size:18px; }
  .muted{ color:var(--muted); font-size:12px; }
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px; margin-bottom:12px;
  }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .pill{ padding:4px 10px; border-radius:999px; border:1px solid var(--line); font-size:12px; background:var(--bg); }
  #status{ font-weight:600; }
  .btn{
    padding:12px 14px; border-radius:12px; border:1px solid var(--line);
    background:var(--bg); color:var(--fg); font-weight:600; flex:1 1 auto;
  }
  .btn:active{ transform:translateY(1px) }
  .btn-primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
  .btn:disabled{ opacity:.5 }
  .grid{
    display:grid; gap:10px; grid-template-columns:1fr 1fr;
  }
  .kv{ display:grid; grid-template-columns: 1fr; gap:6px; }
  .label{ font-size:12px; color:var(--muted); }
  .value{
    font: 700 24px/1.15 ui-monospace,SFMono-Regular,Menlo,monospace;
    padding:10px 12px; border:1px solid var(--line); background:var(--bg); border-radius:12px; min-height:44px;
    display:flex; align-items:center; justify-content:flex-start;
  }
  .toolbar{ display:flex; gap:10px; align-items:center; }
  .grow{ flex:1 1 auto; }
  .toggle{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:var(--bg); }
  details{
    border:1px dashed var(--line); border-radius:12px; padding:10px; background:transparent;
  }
  details summary{ cursor:pointer; font-weight:600; }
  #log{
    margin-top:8px; font:12px/1.5 ui-monospace,monospace; white-space:pre-wrap;
    max-height:160px; overflow:auto; background:#0f172a; color:#e5e7eb; padding:10px; border-radius:10px;
  }

  @media (max-width:380px){
    .grid{ grid-template-columns:1fr; }
    header img{ width:56px; height:56px; }
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <!-- Set your real product image URL below in JS; this SVG is a placeholder -->
    <img id="productImg" alt="Atovio Air Purifier" />
    <div>
      <div class="title">Atovio Air Purifier</div>
      <div class="muted">Bluetooth Control & Live Stats</div>
    </div>
    <div class="grow"></div>
    <button id="btnTheme" class="toggle">üåô</button>
  </header>

  <div class="card">
    <div class="row" style="margin-bottom:8px;">
      <div id="status">Status: Idle</div>
      <span class="pill" id="devName">Device: ‚Äî</span>
      <span class="pill" id="devId">ID: ‚Äî</span>
    </div>
    <div class="row">
      <button id="btnConnect"   class="btn btn-primary">Connect</button>
      <button id="btnReconnect" class="btn" disabled>Reconnect</button>
      <button id="btnDisconnect"class="btn" disabled>Disconnect</button>
      <button id="btnScan"      class="btn" disabled>Re-scan</button>
      <button id="btnClearLog"  class="btn">Clear Log</button>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div class="kv"><div class="label">Voltage</div><div class="value" id="valVolt">‚Äî</div></div>
      <div class="kv"><div class="label">Battery %</div><div class="value" id="valPct">‚Äî</div></div>
      <div class="kv"><div class="label">Charging</div><div class="value" id="valCharge">‚Äî</div></div>
      <div class="kv"><div class="label">State</div><div class="value" id="valState">‚Äî</div></div>
      <div class="kv" style="grid-column:1 / -1;"><div class="label">Speeds</div><div class="value" id="valSpeeds">‚Äî</div></div>
    </div>
  </div>

  <details>
    <summary>Log</summary>
    <div id="log"></div>
  </details>
</div>

<script>
/* =========================
   MOBILE CUSTOMER APP BUILD
   ========================= */

// <<< EDIT THIS if your brand image is hosted somewhere >>>
const PRODUCT_IMAGE_URL = "https://cdn.shopify.com/s/files/1/0890/2541/3435/files/Pebble.jpg?v=1755074391"; // e.g. "https://yourcdn.com/atovio/purifier.png"

// Known UUIDs for your device (customer build = no inputs)
const PRIMARY_SERVICE = "12345678-1234-5678-1234-56789abcdef0";
const UUIDS = {
  state:  "12345678-1234-5678-1234-56789abcdef0", // text: "Normal"/"Turbo"/"Off" (write 'n'/'t'/'o' if you expose controls later)
  volt:   "87654321-1234-5678-1234-56789abcdef0", // text: "3.93V"
  pct:    "abcdef01-1234-5678-1234-56789abcdef0", // text: "69%"
  charge: "abcdef12-3456-7890-abcd-ef1234567890", // text: "Charging"/"Not Charging"
  speeds: "a7654321-4321-6789-4321-abcdef012345"  // read-only: "Off: 236834, Slow: 75062, Fast: 0"
};

// State
let device, server, service;
let reconnecting = false, reconnectBackoffMs = 500;
let wakeLock = null;

// Caches
const charCache  = new Map(); // uuid -> { ch, serviceUUID }
const valueCache = new Map(); // uuid -> last value
const pollTimers = new Map(); // uuid -> interval id

// DOM
const $ = s => document.querySelector(s);
const logEl = $('#log');
const td = new TextDecoder();

// UI helpers
function log(msg, level='info'){
  const stamp = new Date().toLocaleTimeString();
  const line = `[${stamp}] ${msg}`;
  logEl.textContent += line + "\n";
  logEl.scrollTop = logEl.scrollHeight;
  console[level === 'error' ? 'error' : (level==='warn' ? 'warn' : 'log')](line);
}
function setStatus(txt, cls=''){ $('#status').textContent = `Status: ${txt}`; $('#status').className = cls; }
function setKv(id, text){ $(id).textContent = text; }
function sanitizeUuid(u){ return (u||'').trim().toLowerCase(); }

function uiEnable(connected){
  $('#btnConnect').disabled    = connected;
  $('#btnDisconnect').disabled = !connected;
  $('#btnReconnect').disabled  = !device;
  $('#btnScan').disabled       = !connected;
}

function rememberValue(uuid, value){
  valueCache.set(sanitizeUuid(uuid), value);
}

// Pretty print helpers
function toHMS(s){
  const t = Math.max(0, parseInt(s||0,10));
  const h = Math.floor(t/3600), m = Math.floor((t%3600)/60), sec = t%60;
  return `${h}h:${String(m).padStart(2,'0')}m:${String(sec).padStart(2,'0')}s`;
}
const prettify = {
  voltage: v => {
    const s = String(v).trim();
    const num = parseFloat(s.replace(/[^\d.]/g,''));
    if (!isNaN(num)) return `${num.toFixed(2)}v`;
    return s || '‚Äî';
  },
  percent: v => {
    const s = String(v).trim();
    const num = parseFloat(s.replace(/[^\d.]/g,''));
    if (!isNaN(num)) return `${Math.round(num)}%`;
    return s || '‚Äî';
  },
  charging: v => {
    const s = String(v).trim().toLowerCase();
    if (!s) return '‚Äî';
    if (s.includes('not')) return 'Not Charging';
    if (s.includes('charg')) return 'Charging';
    return String(v);
  }
};
function parseValue(dv){
  if (!dv) return '‚Äî';
  const bytes = new Uint8Array(dv.buffer);
  try{
    const str = td.decode(bytes);
    if (/[ -~]/.test(str) && str.trim().length) return str;
  }catch{}
  return '0x ' + Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join(' ');
}

// Connectivity guards
async function ensureConnected(){
  if (!device) throw new Error('No device selected');
  if (device.gatt?.connected) return device.gatt;
  setStatus('Reconnecting‚Ä¶');
  try{
    const g = await device.gatt.connect();
    server = g;
    setStatus('Connected');
    log('Reconnected to GATT');
    return g;
  }catch(e){
    handleError('ensureConnected', e);
    throw e;
  }
}
async function tryReconnect(){
  if (reconnecting || !device) return;
  reconnecting = true; reconnectBackoffMs = 500;
  while (device && !device.gatt.connected){
    try{
      await device.gatt.connect();
      server = device.gatt;
      log('Auto-reconnect succeeded');
      reconnecting = false;
      // Reset flows
      charCache.clear();
      for (const [,iid] of pollTimers) clearInterval(iid);
      pollTimers.clear();
      await scanGatt();
      await startDataFlows();
      return;
    }catch(e){
      log(`Reconnect failed: ${e.message} ‚Äî retrying in ${reconnectBackoffMs}ms`, 'warn');
      await new Promise(r=>setTimeout(r, reconnectBackoffMs));
      reconnectBackoffMs = Math.min(reconnectBackoffMs*2, 8000);
    }
  }
  reconnecting = false;
}

async function getCharacteristic(uuid){
  const id = sanitizeUuid(uuid);
  if (!id) throw new Error('Empty UUID');
  const cached = charCache.get(id);
  if (cached?.ch) return cached.ch;

  const g = await ensureConnected();
  // Try primary service first
  if (service){
    try{
      const ch = await service.getCharacteristic(id);
      charCache.set(id, {ch, serviceUUID: service.uuid});
      return ch;
    }catch(_){}
  }
  // Search all allowed services
  const services = await g.getPrimaryServices();
  for (const s of services){
    try{
      const ch = await s.getCharacteristic(id);
      charCache.set(id, {ch, serviceUUID: s.uuid});
      return ch;
    }catch(_){}
  }
  throw new Error(`Characteristic ${id} not found under allowed services.`);
}

async function scanGatt(){
  try{
    setStatus('Scanning‚Ä¶');
    const g = await ensureConnected();
    // getPrimaryService ensures primary exists; store handle for fast path
    service = await g.getPrimaryService(PRIMARY_SERVICE);
    // Warm up cache by touching characteristics we care about
    for (const id of Object.values(UUIDS)){
      try{ await getCharacteristic(id); }catch(_){}
    }
    setStatus('Connected (ready)');
  }catch(e){
    handleError('scanGatt', e);
  }
}

async function subscribe(uuid, onValue){
  const id = sanitizeUuid(uuid);
  await ensureConnected();
  const ch = await getCharacteristic(id);
  const props = ch.properties || {};

  // Initial read (also triggers pairing)
  try{
    const v = await ch.readValue();
    const parsed = parseValue(v);
    rememberValue(id, parsed);
    onValue(parsed);
  }catch(e){
    handleError(`initialRead(${id})`, e, {silent:true});
  }

  if (props.notify || props.indicate){
    try{
      ch.addEventListener('characteristicvaluechanged', ev=>{
        try{
          const parsed = parseValue(ev.target.value);
          rememberValue(id, parsed);
          onValue(parsed);
        }catch(err){ handleError(`onValue(${id})`, err); }
      });
      await ch.startNotifications();
      log(`Notifications started on ${id}`);
      return {subscribed:true};
    }catch(e){
      handleError(`startNotifications(${id})`, e, {silent:true});
    }
  }
  // Fallback to polling
  log(`Falling back to polling on ${id}`, 'warn');
  await poll(id, onValue, 2000);
  return {subscribed:false};
}

async function poll(uuid, onValue, ms=2000){
  const id = sanitizeUuid(uuid);
  const acquire = async () => {
    await ensureConnected();
    return await getCharacteristic(id);
  };
  let ch = await acquire();

  // Clear existing poll for this uuid
  if (pollTimers.has(id)){ clearInterval(pollTimers.get(id)); pollTimers.delete(id); }

  const tick = async () => {
    try{
      const v = await ch.readValue();
      const parsed = parseValue(v);
      rememberValue(id, parsed);
      onValue(parsed);
    }catch(e){
      log(`poll.read(${id}) failed: ${e.message} ‚Äî reconnecting`, 'warn');
      try{ await ensureConnected(); ch = await acquire(); }catch(e2){ handleError(`poll.reconnect(${id})`, e2); }
    }
  };
  await tick();
  const iid = setInterval(tick, ms);
  pollTimers.set(id, iid);
  log(`Polling ${id} every ${ms}ms`);
}

async function startDataFlows(){
  // Voltage
  await subscribe(UUIDS.volt, v => setKv('#valVolt',  prettify.voltage(v)));
  // Battery %
  await subscribe(UUIDS.pct,  v => setKv('#valPct',   prettify.percent(v)));
  // Charging
  await subscribe(UUIDS.charge, v => setKv('#valCharge', prettify.charging(v)));
  // State
  await subscribe(UUIDS.state, v => setKv('#valState', String(v).trim() || '‚Äî'));
  // Speeds (custom text ‚Üí H:M:S formatting)
  await poll(UUIDS.speeds, raw => {
    const txt = String(raw);
    const parts = {};
    txt.split(',').map(x=>x.trim()).forEach(x=>{
      if (!x) return;
      const i = x.indexOf(':'); if (i === -1) return;
      const k = x.slice(0,i).trim();
      const val = x.slice(i+1).trim().replace(/[^\d]/g,'');
      parts[k] = val||'0';
    });
    const pretty = [`Off: ${toHMS(parts.Off)}`, `Slow: ${toHMS(parts.Slow)}`, `Fast: ${toHMS(parts.Fast)}`].join(', ');
    rememberValue(UUIDS.speeds, pretty);
    setKv('#valSpeeds', pretty);
  }, 2000);
}

function onDisconnected(){
  uiEnable(false);
  setStatus('Disconnected');
  for (const [,iid] of pollTimers) clearInterval(iid);
  pollTimers.clear();
  log('Device disconnected');
  tryReconnect();
}

async function disconnect(){
  try{ if (device && device.gatt?.connected) device.gatt.disconnect(); }
  catch(e){ handleError('disconnect', e); }
  finally{ onDisconnected(); }
}

function handleError(where, e, opts={}){
  const name = e?.name || 'Error';
  const msg  = e?.message || String(e);
  const hint = hintForError(name, msg);
  if (!opts.silent){
    log(`${where}: ${name}: ${msg}`, 'error');
    if (hint) log(`Hint: ${hint}`, 'warn');
    setStatus(`${name}: ${msg}`, 'err');
  }
}
function hintForError(name, msg){
  const m = (msg||'').toLowerCase();
  if (m.includes('not supported') && m.includes('bluetooth')) return 'This browser/device does not support Web Bluetooth.';
  if (m.includes('not found under allowed services')) return 'Firmware UUID outside allowed service. (Developer action)';
  if (m.includes('no services matching')) return 'Service not found on device.';
  if (m.includes('security') || m.includes('not authorized') || m.includes('insufficient')) return 'Requires pairing; accept the OS prompt.';
  if (m.includes('disconnected')) return 'Move closer / keep screen awake.';
  return '';
}

// UI bindings
$('#btnConnect').onclick = async () => {
  try{
    if (!navigator.bluetooth){ alert('This browser does not support Web Bluetooth. Use Chrome on Android or Desktop.'); return; }
    setStatus('Requesting device‚Ä¶');
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices:true,
      optionalServices:[PRIMARY_SERVICE] // add more service UUIDs here if needed in future
    });
    device.addEventListener('gattserverdisconnected', onDisconnected);
    $('#devName').textContent = 'Device: ' + (device.name || 'Unknown');
    $('#devId').textContent   = 'ID: ' + (device.id || '‚Äî');

    setStatus('Connecting‚Ä¶');
    server = await device.gatt.connect();
    service = await server.getPrimaryService(PRIMARY_SERVICE);

    // Keep screen awake to reduce drops
    if ('wakeLock' in navigator && !wakeLock){
      try{
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener?.('release', ()=>{ wakeLock=null; });
        log('Wake lock acquired');
      }catch(e){ log('Wake lock failed: ' + e.message, 'warn'); }
    }

    uiEnable(true);
    setStatus('Connected');
    log(`Connected to ${device.name || 'device'} (${device.id || 'no-id'})`);

    await scanGatt();
    await startDataFlows();
  }catch(e){
    handleError('connectFlow', e);
  }
};
$('#btnReconnect').onclick = async () => { try{ await ensureConnected(); await scanGatt(); await startDataFlows(); }catch(e){ handleError('reconnect', e); } };
$('#btnDisconnect').onclick = () => disconnect();
$('#btnScan').onclick       = () => scanGatt();
$('#btnClearLog').onclick   = () => { $('#log').textContent=''; };

const root = document.documentElement;
$('#btnTheme').onclick = () => {
  if (root.getAttribute('data-theme')==='dark'){
    root.removeAttribute('data-theme'); $('#btnTheme').textContent='üåô';
  }else{
    root.setAttribute('data-theme','dark'); $('#btnTheme').textContent='‚òÄÔ∏è';
  }
};

// Product image setup (inline SVG placeholder if no URL)
(function setProductImg(){
  const el = $('#productImg');
  if (PRODUCT_IMAGE_URL){
    el.src = PRODUCT_IMAGE_URL;
  }else{
    const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='128' height='128' viewBox='0 0 128 128'>
      <rect x='16' y='10' width='96' height='108' rx='16' ry='16' fill='%23ffffff' stroke='%232563eb' stroke-width='3'/>
      <rect x='24' y='22' width='80' height='20' rx='6' ry='6' fill='%232563eb' opacity='0.1'/>
      <rect x='24' y='50' width='80' height='8' rx='4' ry='4' fill='%232563eb' opacity='0.15'/>
      <rect x='24' y='64' width='80' height='8' rx='4' ry='4' fill='%232563eb' opacity='0.15'/>
      <rect x='24' y='78' width='80' height='8' rx='4' ry='4' fill='%232563eb' opacity='0.15'/>
      <circle cx='64' cy='102' r='8' fill='%232563eb'/>
    </svg>`);
    el.src = `data:image/svg+xml;utf8,${svg}`;
  }
})();

// Warn early if unsupported browser (especially iOS)
document.addEventListener('DOMContentLoaded', () => {
  if (!('bluetooth' in navigator)){
    setStatus('Web Bluetooth not supported', 'err');
    log('Web Bluetooth unsupported on this device/browser', 'error');
  }
});
</script>
</body>
</html>
